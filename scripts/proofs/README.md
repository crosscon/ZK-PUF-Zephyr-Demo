# Verifier Proof scripts

This directory contains scripts that were developed with
[SageMath](https://www.sagemath.org/) that allow working with and debugging the
verification process of the Zero Knowledge PUF scheme provided within the
CROSSCON Project:

- [`proof_verifier_calc.sage`](./proof_verifier_calc.sage)
- [`proof_full_calc.sage`](./proof_full_calc.sage)
- [`hash_to_curve_h_calc.sage`](./hash_to_curve_h_calc.sage)

Scripts can be run with:

```sh
sage <script>
```
## Verification

The full verification follows the equation:

$$
g^v \cdot h^w = g^{r+\alpha R_1} \cdot h^{u+\alpha R_2} = g^r \cdot g^{\alpha R_1} \cdot h^u \cdot h^{\alpha R_2} = P \cdot (g^{R_1} \cdot h^{R_2})^{\alpha} = P \cdot \textit{COM}^{\alpha}
$$

This verification process guarantees the verifier that the prover indeed holds
the two PUF responses, $R_1$ and $R_2$, and further ensures the session’s
freshness. For the zero-knowledge proofs $v$ and $w$ to be validated, the prover
is required to use the same $\alpha$ as the verifier, thereby incorporating the
nonce $n$. The $\alpha$ can be reconstructed by the prover from $P$ and $n$.
This mechanism ensures the uniqueness and security of each session, effectively
preventing replay attacks.

## `proof_verifier_calc`

This script follows the above equation and can be used to authenticate the device
using the information sent over by a prover which are:

- **Public data generated during device enrollment**
    - $g$
    - $h$
    - $\textit{COM}$
- **Data sent over during authentication**
    - $P$
    - $v$
    - $w$
- **Data sent over by verifier during authentication to ensure freshness of response**
    - $n$

It can be used either in an interactive mode via `-i` flag where each value
gets prompted for or in CLI mode where it acts as a script.

```sh
$ sage proof_verifier_calc.sage \
-gx 48439561293906451759052585252797914202762949526041747995844080717082404635286 \
-gy 36134250956749795798585127919587881956611106672985015071877198253568414405109 \
-hx 94624073665156338432147328534689061835260841723346385244027009742068139364825 \
-hy 73403294967218502523730502508903820209392371161415112774469248920960131285988 \
-COMx 112025756240634438179565736028181969404122566454882291152297849976449250317343 \
-COMy 10650545265491542385826920540605919365094971694727917883612805206310072466114 \
-Px 35977119548923257066080559284177415522545610302617332213904496628370988051737 \
-Py 38713224707483900159478453191764526895444582901145527031626248970917199917364 \
-v 792399813392095348971797152771925823313242907911907556392531248393922463594766528183389183375614642757537811209602855389808522711850594471442217056242501 \
-w 2357955185347516328316068892761109705450204554033207975864232110364548139844082018563954738779955708629152840189256415617268361278997714407554772550586525 \
-n 0x8899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF0011223344556677

Step 1: Define secp256r1 curve (P-256)...
Curve defined over F_p with equation: y^2 = x^3 + ax + b

=== Zero Knowledge Verifier Proof Tool (CLI Mode) ===

Step 2: g = E((0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296, 0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5)) -> (48439561293906451759052585252797914202762949526041747995844080717082404635286 : 36134250956749795798585127919587881956611106672985015071877198253568414405109 : 1)
h = E((0xd13353e86b41f94c8877f68fb95aad0a35820695e2037413bd57a9c447df11d9, 0xa248caebbb366b69fdebd312588b9702d81de34eed740ed27a246d2ee7ba43e4)) -> (94624073665156338432147328534689061835260841723346385244027009742068139364825 : 73403294967218502523730502508903820209392371161415112774469248920960131285988 : 1)

Step 3: COM = E((0xf7ac54c0d4eaf8cb2f5caddf03500e8bc922f8c841cf2b7299164a1bfa07541f, 0x178bfeb811c197ca942c65a6cc240774df4b263ffef3d5b08ae7ae5a8cb5bac2)) -> (112025756240634438179565736028181969404122566454882291152297849976449250317343 : 10650545265491542385826920540605919365094971694727917883612805206310072466114 : 1)

Step 4: nonce = 0x8899aabbccddeeff00112233445566778899aabbccddeeff00112233445566778899aabbccddeeff00112233445566778899aabbccddeeff0011223344556677

Step 5: P = E((0x4f8a53fb26199993b1b4e270ee46c20ef09172994b8b51174516ce1c0e5fad19, 0x5596e89ffabc45ef0b1a38bd12daebddbef4a47278e46ea7194e671d4602b134)) -> (35977119548923257066080559284177415522545610302617332213904496628370988051737 : 38713224707483900159478453191764526895444582901145527031626248970917199917364 : 1)

Step 6: v = 0xf212b6b5ceb8d9744ed82d14ecaea3eb34765cab3224c8c3a400e85bf0a9956c5ff1a7f079442af52152ae54b4e27820ebaf3aebaa51462a3475f31a40a8b45, w = 0x2d0571e2867f05098c79635c6b1214c759ba73f9564fc8304e465339d046ff9a701b1bb19c8a6c8c956bdfa670618874c43ebeae56c0e77677e3ccc9e46c909d


Step 7: Reconstruct raw P.x||P.y as hex
P (hex) = 4F8A53FB26199993B1B4E270EE46C20EF09172994B8B51174516CE1C0E5FAD195596E89FFABC45EF0B1A38BD12DAEBDDBEF4A47278E46EA7194E671D4602B134

Step 8: Reconstruct raw 64-byte n as hex
n (hex) = 8899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF0011223344556677

Step 9: Preimage (P || nonce) as hex:
4F8A53FB26199993B1B4E270EE46C20EF09172994B8B51174516CE1C0E5FAD195596E89FFABC45EF0B1A38BD12DAEBDDBEF4A47278E46EA7194E671D4602B1348899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF0011223344556677

Step 10: Compute α = H(P, n)
α (as hex) = 5AA57FECBEAD02A319BD38F2D569AE9E2DF4EF4FD9E9C0F81AC6F68C19E87689
α (as integer) = 41000569042596371943937215406998711834023127337694396939792979043088329111177

Step 11: Check if g^v*h^w=P*COM^α
g^v * h^w = (31182487165452795660700373914290676797411520466220590550296240449630842827182 : 75314957680499870089202413026433607192812385619111420323720715698074380668656 : 1)
P * COM^α = (31182487165452795660700373914290676797411520466220590550296240449630842827182 : 75314957680499870089202413026433607192812385619111420323720715698074380668656 : 1)
✅ Proof verifies: g^v·h^w = P·COM^α
Computation complete
```

```sh
$ sage proof_verifier_calc.sage -i

Step 1: Define secp256r1 curve (P-256)...
Curve defined over F_p with equation: y^2 = x^3 + ax + b

=== Zero Knowledge Verifier Proof Tool (Interactive Mode) ===

Step 2: Input coordinates for g and h (decimal or hex with 0x prefix)
Enter g_x: 48439561293906451759052585252797914202762949526041747995844080717082404635286
Enter g_y: 36134250956749795798585127919587881956611106672985015071877198253568414405109
g = E((0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296, 0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5)) -> (4843956129390645175905258525279791420276
2949526041747995844080717082404635286 : 36134250956749795798585127919587881956611106672985015071877198253568414405109 : 1)
Enter h_x: 94624073665156338432147328534689061835260841723346385244027009742068139364825
Enter h_y: 73403294967218502523730502508903820209392371161415112774469248920960131285988
h = E((0xd13353e86b41f94c8877f68fb95aad0a35820695e2037413bd57a9c447df11d9, 0xa248caebbb366b69fdebd312588b9702d81de34eed740ed27a246d2ee7ba43e4)) -> (9462407366515633843214732853468906183526
0841723346385244027009742068139364825 : 73403294967218502523730502508903820209392371161415112774469248920960131285988 : 1)

Step 3: Input coordinates for COM (decimal or hex with 0x prefix)
Enter COM_x: 112025756240634438179565736028181969404122566454882291152297849976449250317343
Enter COM_y: 10650545265491542385826920540605919365094971694727917883612805206310072466114
COM = E((0xf7ac54c0d4eaf8cb2f5caddf03500e8bc922f8c841cf2b7299164a1bfa07541f, 0x178bfeb811c197ca942c65a6cc240774df4b263ffef3d5b08ae7ae5a8cb5bac2)) -> (11202575624063443817956573602818196940
4122566454882291152297849976449250317343 : 10650545265491542385826920540605919365094971694727917883612805206310072466114 : 1)

Step 4: Enter scalar nonce (decimal or hex with 0x prefix)
Enter nonce: 0x8899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF0011223344556677
nonce = 0x8899aabbccddeeff00112233445566778899aabbccddeeff00112233445566778899aabbccddeeff00112233445566778899aabbccddeeff0011223344556677

Step 5: Input coordinates for P (decimal or hex with 0x prefix)
Enter P_x: 35977119548923257066080559284177415522545610302617332213904496628370988051737
Enter P_y: 38713224707483900159478453191764526895444582901145527031626248970917199917364
P = E((0x4f8a53fb26199993b1b4e270ee46c20ef09172994b8b51174516ce1c0e5fad19, 0x5596e89ffabc45ef0b1a38bd12daebddbef4a47278e46ea7194e671d4602b134)) -> (3597711954892325706608055928417741552254
5610302617332213904496628370988051737 : 38713224707483900159478453191764526895444582901145527031626248970917199917364 : 1)

Step 6: Enter scalars v and w (decimal or hex with 0x prefix)
Enter v: 792399813392095348971797152771925823313242907911907556392531248393922463594766528183389183375614642757537811209602855389808522711850594471442217056242501
Enter w: 2357955185347516328316068892761109705450204554033207975864232110364548139844082018563954738779955708629152840189256415617268361278997714407554772550586525
v = 0xf212b6b5ceb8d9744ed82d14ecaea3eb34765cab3224c8c3a400e85bf0a9956c5ff1a7f079442af52152ae54b4e27820ebaf3aebaa51462a3475f31a40a8b45, w = 0x2d0571e2867f05098c79635c6b1214c759ba73f9564fc83
04e465339d046ff9a701b1bb19c8a6c8c956bdfa670618874c43ebeae56c0e77677e3ccc9e46c909d


Step 7: Reconstruct raw P.x||P.y as hex
P (hex) = 4F8A53FB26199993B1B4E270EE46C20EF09172994B8B51174516CE1C0E5FAD195596E89FFABC45EF0B1A38BD12DAEBDDBEF4A47278E46EA7194E671D4602B134

Step 8: Reconstruct raw 64-byte n as hex
n (hex) = 8899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF0011223344556677

Step 9: Preimage (P || nonce) as hex:
4F8A53FB26199993B1B4E270EE46C20EF09172994B8B51174516CE1C0E5FAD195596E89FFABC45EF0B1A38BD12DAEBDDBEF4A47278E46EA7194E671D4602B1348899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF001122334455
66778899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF0011223344556677

Step 10: Compute α = H(P, n)
α (as hex) = 5AA57FECBEAD02A319BD38F2D569AE9E2DF4EF4FD9E9C0F81AC6F68C19E87689
α (as integer) = 41000569042596371943937215406998711834023127337694396939792979043088329111177

Step 11: Check if g^v*h^w=P*COM^α
g^v * h^w = (31182487165452795660700373914290676797411520466220590550296240449630842827182 : 75314957680499870089202413026433607192812385619111420323720715698074380668656 : 1)
P * COM^α = (31182487165452795660700373914290676797411520466220590550296240449630842827182 : 75314957680499870089202413026433607192812385619111420323720715698074380668656 : 1)
✅ Proof verifies: g^v·h^w = P·COM^α
Computation complete
```

## `proof_full_calc.sage`

This script is aimed for development/debugging and calculates every variable
used within the proof. The user needs to manually parse $g$, $h$, $R_1$, $R_2$,
$r$, $u$ and $n$.

## `hash_to_curve_h_calc.sage`

This script is aimed for development/debugging and aims to reproduce how $h$ is
generated in the code using Hash-to-Curve to be fully independent of $g$.
